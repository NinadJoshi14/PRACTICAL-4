<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Secure Message Decryptor</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; max-width:800px; margin:40px auto; text-align:center; }
    input[type=text] { padding:10px; width:320px; font-size:16px; }
    button { padding:10px 18px; font-size:16px; margin-left:8px; }
    .label { font-weight:700; margin-top:18px; }
    .result { margin-top:18px; font-size:18px; }
    .small { font-size:14px; color:#555; margin-top:6px; }
    .field { margin-top:12px; }
  </style>
</head>
<body>
  <h1>Secure Message Decryptor</h1>
  <p>Enter the decryption key below to reveal the message.</p>

  <div class="field">
    <input id="keyInput" type="text" placeholder="Enter decryption key" />
    <button id="decryptBtn">Decrypt</button>
  </div>

  <div class="label" id="ctLabel">Ciphertext: <span id="ctValue" style="font-weight:normal"></span></div>
  <div class="label">Decrypted Message:</div>
  <div id="ptValue" class="result"></div>

  <div class="small" id="origUrlArea"></div>

<script>
(function(){
  // Read URL params
  function getParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

  const ciphertext = getParam('c') || '';
  const originalUrl = getParam('u') || '';

  const ctValue = document.getElementById('ctValue');
  const ptValue = document.getElementById('ptValue');
  const origUrlArea = document.getElementById('origUrlArea');

  ctValue.textContent = ciphertext ? ciphertext : 'No data found in URL.';
  if (originalUrl) {
    origUrlArea.innerHTML = 'Original URL used for encryption: <a href="' + escapeHtml(originalUrl) + '" target="_blank">' + escapeHtml(originalUrl) + '</a>';
  }

  document.getElementById('decryptBtn').addEventListener('click', function(){
    const key = document.getElementById('keyInput').value || '';
    if (!ciphertext) { ptValue.textContent = 'No ciphertext to decrypt.'; return; }
    if (!key) { ptValue.textContent = 'Please enter decryption key.'; return; }
    try {
      const pt = columnar_decrypt(ciphertext, key);
      ptValue.textContent = pt;
    } catch (e) {
      ptValue.textContent = 'Decryption error: ' + e.message;
    }
  });

  // Columnar transposition decryption (mirrors the python encrypt)
  function columnar_decrypt(ct, keyword, padChar='X') {
    // ct length and keyword length
    const n = keyword.length;
    const L = ct.length;
    const rows = Math.ceil(L / n);

    // Determine column order used during encryption: sorted by char then original index
    const cols = [];
    for (let i=0;i<keyword.length;i++) cols.push({ch: keyword[i], idx: i});
    cols.sort((a,b) => {
      if (a.ch < b.ch) return -1;
      if (a.ch > b.ch) return 1;
      return a.idx - b.idx;
    });

    // How many characters in each column? Because we always padded to full rows during encryption,
    // each column will have exactly `rows` characters.
    // So slice ciphertext in the sorted column order into column strings of length = rows
    const columns = new Array(n);
    let pos = 0;
    for (let k=0;k<cols.length;k++){
      const colIndex = cols[k].idx;
      columns[colIndex] = ct.slice(pos, pos + rows).split('');
      pos += rows;
    }

    // Now rebuild plaintext reading row-wise left->right across original column ordering
    let plaintext = '';
    for (let r=0;r<rows;r++){
      for (let col=0; col<n; col++){
        const arr = columns[col];
        if (!arr) continue;
        if (r < arr.length) plaintext += arr[r];
      }
    }

    // Strip trailing pad characters that were used (X). Only strip trailing pad chars.
    while (plaintext.endsWith(padChar)) plaintext = plaintext.slice(0, -1);
    return plaintext;
  }

  // small helper to escape HTML in output
  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];});
  }

})();
</script>
</body>
</html>
